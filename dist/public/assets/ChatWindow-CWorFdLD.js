import{t as n,r as i,a as d,j as e,C as h,B as u,X as D,I as y}from"./index-DG0yx2hi.js";import{M as g,A as b,B as p}from"./popover-Bqiz4euq.js";import{S as C}from"./scroll-area-C0S6gB82.js";import{I as E}from"./image-BoirZu0B.js";import{S as R}from"./send-BU_qFC5s.js";function L({conversationId:M,petId:$}){const{data:S}=n.auth.me.useQuery(),f=n.useUtils(),l=i.useRef(null),[t,A]=i.useState(M||null),[o,j]=i.useState(""),[r,m]=i.useState(null),{data:x}=n.chat.getConversations.useQuery(),{data:c}=n.chat.getMessages.useQuery({conversationId:t},{enabled:!!t,refetchInterval:3e3}),N=n.chat.sendMessage.useMutation({onSuccess:()=>{f.chat.getMessages.invalidate({conversationId:t}),f.chat.getConversations.invalidate(),j(""),m(null),v()},onError:s=>{d.error(`Erro ao enviar mensagem: ${s.message}`)}}),v=()=>{l.current&&(l.current.scrollTop=l.current.scrollHeight)};i.useEffect(()=>{v()},[c]);const I=s=>{const a=s.target.files?.[0];if(a){if(a.size>10*1024*1024){d.error("Arquivo muito grande. Máximo 10MB");return}m(a)}},w=async()=>{if(!o.trim()&&!r){d.error("Digite uma mensagem ou selecione um arquivo");return}if(!t){d.error("Selecione uma conversa");return}let s;if(r){const a=new FileReader;s=await new Promise(B=>{a.onloadend=()=>B(a.result),a.readAsDataURL(r)})}await N.mutateAsync({conversationId:t,content:o||void 0,mediaData:s,messageType:r?r.type.startsWith("image/")?"image":"video":"text"})};return e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-12rem)]",children:[e.jsxs(h,{className:"p-4 overflow-hidden flex flex-col",children:[e.jsxs("h3",{className:"font-semibold mb-4 flex items-center gap-2",children:[e.jsx(g,{className:"h-5 w-5"}),"Conversas"]}),e.jsx(C,{className:"flex-1",children:e.jsxs("div",{className:"space-y-2",children:[x&&x.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhuma conversa ainda"}),x?.map(s=>e.jsx(h,{className:`p-3 cursor-pointer hover:bg-accent transition-colors ${t===s.id?"bg-accent":""}`,onClick:()=>A(s.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(b,{className:"h-10 w-10 bg-orange-100 flex items-center justify-center",children:e.jsx("span",{className:"text-orange-600 font-semibold",children:s.participantName?.charAt(0)||"U"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsx("p",{className:"font-semibold text-sm truncate",children:s.participantName}),s.unreadCount>0&&e.jsx(p,{variant:"destructive",className:"h-5 w-5 p-0 flex items-center justify-center text-xs",children:s.unreadCount})]}),s.petName&&e.jsx(p,{variant:"secondary",className:"text-xs mt-1",children:s.petName}),e.jsx("p",{className:"text-xs text-muted-foreground truncate mt-1",children:s.lastMessage||"Nenhuma mensagem"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:s.lastMessageAt&&new Date(s.lastMessageAt).toLocaleString("pt-BR")})]})]})},s.id))]})})]}),e.jsx(h,{className:"lg:col-span-2 p-4 overflow-hidden flex flex-col",children:t?e.jsxs(e.Fragment,{children:[e.jsx(C,{className:"flex-1 pr-4",ref:l,children:e.jsxs("div",{className:"space-y-4",children:[c&&c.length===0&&e.jsx("p",{className:"text-sm text-muted-foreground text-center py-8",children:"Nenhuma mensagem ainda. Envie a primeira!"}),c?.map(s=>{const a=s.senderId===S?.id;return e.jsxs("div",{className:`flex gap-3 ${a?"flex-row-reverse":""}`,children:[e.jsx(b,{className:`h-8 w-8 ${a?"bg-orange-100":"bg-gray-100"} flex items-center justify-center flex-shrink-0`,children:e.jsx("span",{className:`${a?"text-orange-600":"text-gray-600"} text-sm font-semibold`,children:s.senderName?.charAt(0)||"U"})}),e.jsxs("div",{className:`flex flex-col ${a?"items-end":"items-start"} max-w-[70%]`,children:[e.jsxs("div",{className:`rounded-lg p-3 ${a?"bg-orange-500 text-white":"bg-gray-100"} relative`,children:[s.source==="whatsapp"&&e.jsx("div",{className:"absolute -top-2 -right-2 bg-green-500 rounded-full p-1",children:e.jsx(g,{className:"h-3 w-3 text-white"})}),s.message&&e.jsx("p",{className:"text-sm whitespace-pre-wrap",children:s.message}),s.mediaUrl&&e.jsx("img",{src:s.mediaUrl,alt:"Media",className:"mt-2 rounded max-w-full"})]}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(s.createdAt).toLocaleTimeString("pt-BR",{hour:"2-digit",minute:"2-digit"})}),s.source==="whatsapp"&&e.jsx(p,{variant:"outline",className:"text-[10px] px-1 py-0 h-4 bg-green-50 text-green-700 border-green-200",children:"WhatsApp"})]})]})]},s.id)})]})}),e.jsxs("div",{className:"mt-4 space-y-2",children:[r&&e.jsxs("div",{className:"flex items-center gap-2 p-2 bg-gray-100 rounded",children:[e.jsx("span",{className:"text-sm flex-1 truncate",children:r.name}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>m(null),children:e.jsx(D,{className:"h-4 w-4"})})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"file",accept:"image/*,video/*",className:"hidden",id:"chat-media",onChange:I}),e.jsx("label",{htmlFor:"chat-media",children:e.jsx(u,{variant:"outline",size:"icon",asChild:!0,children:e.jsx("span",{className:"cursor-pointer",children:e.jsx(E,{className:"h-4 w-4"})})})}),e.jsx(y,{placeholder:"Digite sua mensagem...",value:o,onChange:s=>j(s.target.value),onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),w())},className:"flex-1"}),e.jsx(u,{onClick:w,disabled:N.isPending,children:e.jsx(R,{className:"h-4 w-4"})})]})]})]}):e.jsx("div",{className:"flex-1 flex items-center justify-center text-muted-foreground",children:e.jsxs("div",{className:"text-center",children:[e.jsx(g,{className:"h-16 w-16 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"Selecione uma conversa para começar"})]})})})]})}export{L as C};
