Perfeito! Agora entendemos o problema: `users.id` é `BIGINT` (int8), mas a função retorna `INTEGER` (int4).

**CONFIRMAÇÃO: Pode prosseguir com a Opção 1 (atualizar função para retornar bigint).**

Por favor, execute a atualização da função `extract_tutor_id_from_path`:

**1. Atualizar a função para retornar bigint:**
```sql
CREATE OR REPLACE FUNCTION public.extract_tutor_id_from_path(
  file_path text
) RETURNS bigint  -- ✅ MUDOU DE integer PARA bigint
LANGUAGE plpgsql
IMMUTABLE
AS $$
DECLARE
  path_parts text[];
  tutor_id_str text;
BEGIN
  IF file_path IS NULL OR file_path = '' THEN
    RETURN NULL;
  END IF;
  
  path_parts := string_to_array(file_path, '/');
  
  IF array_length(path_parts, 1) >= 2 THEN
    tutor_id_str := path_parts[2];
    BEGIN
      RETURN tutor_id_str::bigint;  -- ✅ MUDOU DE ::int PARA ::bigint
    EXCEPTION WHEN OTHERS THEN
      RETURN NULL;
    END;
  END IF;
  
  RETURN NULL;
END;
$$;
```

**2. Após atualizar, validar:**
```sql
-- Verificar definição da função
SELECT 
  proname as function_name,
  pg_get_function_arguments(oid) as arguments,
  pg_get_function_result(oid) as return_type
FROM pg_proc 
WHERE pronamespace = 'public'::regnamespace 
  AND proname = 'extract_tutor_id_from_path';

-- Testar a função
SELECT 
  'tutors/123/arquivo.pdf' as test_path,
  public.extract_tutor_id_from_path('tutors/123/arquivo.pdf') as extracted_id,
  pg_typeof(public.extract_tutor_id_from_path('tutors/123/arquivo.pdf')) as id_type;
-- Resultado esperado: extracted_id = 123, id_type = bigint
```

**3. Verificar que as políticas ainda funcionam:**
```sql
SELECT 
  p.polname as policy_name,
  pg_get_expr(p.qual, p.polrelid) as stored_using_expression,
  pg_get_expr(p.polwithcheck, p.polrelid) as stored_with_check_expression
FROM pg_policy p
JOIN pg_class c ON c.oid = p.polrelid
WHERE c.relname = 'objects'
  AND c.relnamespace = 'storage'::regnamespace
  AND p.polname IN (
    'staff_policy_select',
    'tutors_policy_select',
    'tutors_policy_insert',
    'tutors_policy_update'
  )
ORDER BY p.polname;
```

**Verificar que:**
- ✅ Função retorna `bigint`
- ✅ Políticas comparam `users.id` (bigint) com `extract_tutor_id_from_path(...)` (bigint)
- ✅ Não há mais mismatch de tipos

**Nota:** As políticas não precisam ser alteradas, apenas a função. O PostgreSQL fará a comparação correta automaticamente após a atualização da função.

Pode prosseguir com a atualização da função para retornar `bigint`?


