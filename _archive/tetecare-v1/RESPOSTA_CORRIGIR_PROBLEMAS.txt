Obrigado pela análise detalhada! Identifiquei 2 problemas críticos que precisam correção imediata e 2 melhorias opcionais.

**PROBLEMAS CRÍTICOS (corrigir agora):**

1. **Políticas de `staff` e `tutors`** estão usando `extract_tutor_id_from_path(users.name)` quando deveriam usar `extract_tutor_id_from_path(name)`.

   - A função deve extrair o tutor ID do **caminho do arquivo** (`name` da tabela `storage.objects`), não do nome do usuário.
   - Isso faz com que as políticas não funcionem corretamente.

2. **Correção necessária:**
   - Substituir `extract_tutor_id_from_path(users.name)` por `extract_tutor_id_from_path(name)` em todas as políticas de `staff` e `tutors`.

**MELHORIAS OPCIONAIS (você decide):**

3. **`wall_policy_insert`** está muito permissiva - permite qualquer usuário autenticado inserir sem forçar que seja o owner. Recomendo adicionar `(metadata->>'owner')::uuid = auth.uid()` no `WITH CHECK`.

4. **Leitura pública** de `marketing` e `partnerships` - se isso é intencional para conteúdo público, está correto. Se desejar restringir, podemos alterar para `TO authenticated`.

**AÇÃO SOLICITADA:**

Por favor, execute o script SQL que preparei (`SQL_CORRIGIR_POLITICAS_PROBLEMAS.sql`) para corrigir os problemas críticos de `staff` e `tutors`.

O script:
- Remove as políticas incorretas
- Recria com a lógica correta
- Inclui validação para confirmar que não há mais referências a `users.name`

Após a execução, me informe:
1. Se as correções foram aplicadas com sucesso
2. Se deseja aplicar a melhoria opcional do `wall_policy_insert`
3. Se deseja manter ou alterar a leitura pública de `marketing`/`partnerships`

Pode prosseguir com a correção dos problemas críticos?


