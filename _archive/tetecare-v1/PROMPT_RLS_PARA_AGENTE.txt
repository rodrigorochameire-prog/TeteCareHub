Por favor, execute os seguintes passos para configurar as políticas RLS (Row Level Security) dos buckets de storage:

1. VERIFICAR ESTRUTURA DO BANCO:
   - Execute uma consulta read-only para verificar os nomes exatos das colunas na tabela `public.pet_tutors`:
     - Verificar se é `petId` ou `pet_id`
     - Verificar se é `tutorId` ou `tutor_id`
   - Verificar o tipo da coluna `auth_id` na tabela `public.users` (uuid ou text)

2. CRIAR FUNÇÕES AUXILIARES:
   - Criar função `public.is_tutor_of_pet(user_auth_id uuid, pet_id_param int)` que verifica se um usuário é tutor de um pet específico consultando a tabela `pet_tutors`
   - Criar função `public.extract_pet_id_from_path(file_path text)` que extrai o petId do caminho do arquivo (ex: "pets/123/profile.jpg" -> 123)
   - Criar função `public.is_admin(user_auth_id uuid)` que verifica se o usuário é admin
   - Criar função `public.extract_tutor_id_from_path(file_path text)` para buckets de tutores/staff
   - Todas as funções devem ser `SECURITY DEFINER` e ter `EXECUTE` revogado de `anon` e `authenticated`

3. APLICAR POLÍTICAS RLS NOS BUCKETS:

   BUCKETS PRIVADOS (acesso apenas aos tutores do pet específico + admins):
   - pets: SELECT para tutores do pet + admins, INSERT/UPDATE/DELETE apenas admins
   - daycare-photos: SELECT para tutores do pet + admins, INSERT/UPDATE/DELETE apenas admins
   - documents: SELECT/INSERT/UPDATE para tutores do pet + admins, DELETE apenas admins
   - financial: SELECT para tutores do pet + admins, INSERT/UPDATE/DELETE apenas admins
   - reports: SELECT para tutores do pet + admins, INSERT/UPDATE/DELETE apenas admins
   - products: SELECT/INSERT/UPDATE para tutores do pet + admins, DELETE apenas admins
   - health-logs: SELECT/INSERT/UPDATE para tutores do pet + admins, DELETE apenas admins
   - tutors: SELECT/INSERT/UPDATE para próprio tutor + admins, DELETE apenas admins
   - staff: SELECT para próprio colaborador + admins, INSERT/UPDATE/DELETE apenas admins

   BUCKETS PÚBLICOS:
   - wall: SELECT/INSERT para usuários autenticados, UPDATE/DELETE para owner (via metadados) + admins
   - partnerships: SELECT público, INSERT/UPDATE/DELETE apenas admins
   - marketing: SELECT público, INSERT/UPDATE/DELETE apenas admins

4. IMPORTANTE:
   - As políticas devem usar as funções auxiliares criadas
   - A verificação de tutor deve usar `public.is_tutor_of_pet(auth.uid(), extract_pet_id_from_path(name))`
   - A verificação de admin deve usar `public.is_admin(auth.uid())`
   - Os arquivos devem seguir a estrutura: `{bucket}/{petId}/...` para que a extração funcione

5. TESTAR:
   - Após aplicar, fornecer um resumo das políticas criadas
   - Indicar se há algum ajuste necessário baseado na estrutura real do banco

Pode prosseguir com a execução.


