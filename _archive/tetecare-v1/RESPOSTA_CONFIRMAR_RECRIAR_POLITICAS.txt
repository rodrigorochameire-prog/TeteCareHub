Perfeito! A função está correta. O problema está nas políticas que ainda têm a referência incorreta.

**CONFIRMAÇÃO: Pode prosseguir com a Opção A.**

Por favor, execute:

1. **DROP + CREATE** para as 4 políticas afetadas:
   - `staff_policy_select`
   - `tutors_policy_select`
   - `tutors_policy_update`
   - `tutors_policy_insert`

2. **Usar a expressão correta:**
   ```sql
   extract_tutor_id_from_path(name)  -- ✅ CORRETO: usa 'name' (caminho do arquivo)
   ```
   
   **NÃO usar:**
   ```sql
   extract_tutor_id_from_path(users.name)  -- ❌ ERRADO
   ```

3. **Após recriar, validar:**
   - Verificar que nenhuma política em `storage.objects` referencia `users.name`
   - Confirmar que as 4 políticas foram recriadas corretamente

**Script SQL de referência (se precisar):**

```sql
-- STAFF: SELECT
DROP POLICY IF EXISTS "staff_policy_select" ON storage.objects;
CREATE POLICY "staff_policy_select"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'staff' 
  AND (
    public.is_admin((SELECT auth.uid()))
    OR
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE users.auth_id = (SELECT auth.uid())
        AND users.id = public.extract_tutor_id_from_path(name)  -- ✅ CORRETO
    )
  )
);

-- TUTORS: SELECT
DROP POLICY IF EXISTS "tutors_policy_select" ON storage.objects;
CREATE POLICY "tutors_policy_select"
ON storage.objects FOR SELECT
TO authenticated
USING (
  bucket_id = 'tutors' 
  AND (
    public.is_admin((SELECT auth.uid()))
    OR
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE users.auth_id = (SELECT auth.uid())
        AND users.id = public.extract_tutor_id_from_path(name)  -- ✅ CORRETO
    )
  )
);

-- TUTORS: INSERT
DROP POLICY IF EXISTS "tutors_policy_insert" ON storage.objects;
CREATE POLICY "tutors_policy_insert"
ON storage.objects FOR INSERT
TO authenticated
WITH CHECK (
  bucket_id = 'tutors' 
  AND (
    public.is_admin((SELECT auth.uid()))
    OR
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE users.auth_id = (SELECT auth.uid())
        AND users.id = public.extract_tutor_id_from_path(name)  -- ✅ CORRETO
    )
  )
);

-- TUTORS: UPDATE
DROP POLICY IF EXISTS "tutors_policy_update" ON storage.objects;
CREATE POLICY "tutors_policy_update"
ON storage.objects FOR UPDATE
TO authenticated
USING (
  bucket_id = 'tutors' 
  AND (
    public.is_admin((SELECT auth.uid()))
    OR
    EXISTS (
      SELECT 1 FROM public.users 
      WHERE users.auth_id = (SELECT auth.uid())
        AND users.id = public.extract_tutor_id_from_path(name)  -- ✅ CORRETO
    )
  )
);
```

**Validação após execução:**

```sql
-- Verificar se não há mais referências a users.name
SELECT 
  policyname,
  qual as using_expression,
  with_check as with_check_expression
FROM pg_policies 
WHERE schemaname = 'storage' 
  AND tablename = 'objects'
  AND (
    qual LIKE '%users.name%' 
    OR with_check LIKE '%users.name%'
  );
```

**Resultado esperado:** 0 linhas

Pode prosseguir com a recriação das 4 políticas?


